---

- include_vars: "{{ private_dir }}/p.yml"

- name: install docker-py
  command: pip install docker-py

- name: upstart docker conf - ulimit open files
  copy: src=etc/init/upstart_docker.conf dest=/etc/init/docker.conf
        owner=root
        group=root
        mode=644
#notify: reload docker
  tags: upstart-docker

- name: setup quay.io /root/.docker.cfg
  copy: src='{{ private_dir }}/../docker/docker.cfg'
        dest=/root/.docker.cfg
        owner=root
        group=root
        mode=600

- name: ensure /data dir
  file: path=/data state=directory

#run -e ETHERPAD_DBHOST=127.0.0.1 -e ETHERPAD_DB=dbname -e ETHERPAD_USER=username -e ETHERPAD_PASS=mypass -e ADMIN_PASS=adminpass -d -p  127.0.0.1:9001:9001 -i quay.io/okfn/okfnpad.org:latest
- name: ensure etherpad container is running
  docker: image=okfn/etherpad_lite ports=127.0.0.1:9001:9001 name=okfnpad.org env="ETHERPAD_DB={{ aws_rds_mysql_host }},ETHERPAD_USER={{ etherpad_db_user }},ETHERPAD_PASS={{ etherpad_db_pass }},ADMIN_PASS={{ etherpad_admin_pass }}"
  tags: start-okfnpad

#docker run -d -p  127.0.0.1:8000:8000  --name booktype.okfn.org okfn/booktype.okfn.org
- name: ensure booktype container is running
  docker: image=okfn/booktype.okfn.org ports=127.0.0.1:8000:8000 name=booktype.okfn.org
  tags: start-booktype

#docker run -d --env="APP_PATH=https://sendy.okfn.org DATABASE_PASS=***" -p  127.0.0.1:8001:80 --name sendy.okfn.org  okfn/opensendy:1.1.9~2
- name: ensure sendy container is running
  docker: image=okfn/opensendy:1.1.9~2 ports=127.0.0.1:8001:80 name=sendy.okfn.org env="DATABASE_PASS={{ sendy_okfn_org_db_pw }},APP_PATH=https://sendy.okfn.org"
  tags: start-sendy
